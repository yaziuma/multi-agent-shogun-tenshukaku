{% extends "base.html" %}

{% block content %}
<div class="container">
    <!-- ã‚¿ãƒ–ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ -->
    <nav class="tab-nav">
        <button type="button" class="tab-btn active" data-tab="command" hx-disable>æŒ‡æ®</button>
        <button type="button" class="tab-btn" data-tab="monitor" hx-disable>ç›£è¦–</button>
        <button type="button" class="tab-btn" data-tab="dashboard" hx-disable>æˆ¦æ³</button>
        <button type="button" class="tab-btn" data-tab="history" hx-disable>å±¥æ­´</button>
    </nav>

    <!-- ã‚¿ãƒ–1: æŒ‡æ® -->
    <div class="tab-content active" id="tab-command">
        <section class="command-input">
            <h2>ğŸ’¬ å°†è»ã¨ã®ä¼šè©±</h2>
            <form hx-post="/api/command" hx-target="#command-result" hx-swap="innerHTML"
                  hx-on::after-request="if(event.detail.successful) this.reset()">
                <textarea name="instruction" rows="5" placeholder="å°†è»ã«è©±ã—ã‹ã‘ã‚‹..."></textarea>
                <div class="btn-row">
                    <button type="submit">é€ä¿¡</button>
                    <button type="button" id="esc-btn" class="esc-btn">Esc</button>
                </div>
            </form>
            <div id="command-result"></div>
        </section>

        <section class="chat-log-section">
            <h2>ğŸ“ ä¼šè©±ãƒ­ã‚°</h2>
            <div id="chat-log"></div>
        </section>

        <details class="raw-output-details">
            <summary>ğŸ”„ tmux rawå‡ºåŠ›ï¼ˆæŠ˜ã‚ŠãŸãŸã¿ï¼‰</summary>
            <div id="shogun-output" class="terminal"><pre>æ¥ç¶šä¸­...</pre></div>
        </details>
    </div>

    <!-- ã‚¿ãƒ–2: ç›£è¦– -->
    <div id="tab-monitor" class="tab-content">
        <section class="monitor-section">
        <h2>ğŸ‘ï¸ å…¨ãƒšã‚¤ãƒ³ç›£è¦–</h2>
        <div id="monitor-grid" class="monitor-grid">
            <!-- WebSocketã§å‹•çš„ã«ç”Ÿæˆ -->
            <div class="monitor-loading">æ¥ç¶šä¸­...</div>
        </div>
        </section>
    </div>

    <!-- ã‚¿ãƒ–3: æˆ¦æ³ -->
    <div class="tab-content" id="tab-dashboard">
        <section class="dashboard">
            <h2>ğŸ“Š ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</h2>
            <div hx-get="/api/dashboard" hx-trigger="load, every 5s" hx-swap="innerHTML">
                Loading...
            </div>
        </section>
    </div>

    <!-- ã‚¿ãƒ–3: å±¥æ­´ -->
    <div class="tab-content" id="tab-history">
        <section class="command-history">
            <h2>ğŸ“œ ã‚³ãƒãƒ³ãƒ‰å±¥æ­´</h2>
            {% include "partials/history.html" %}
        </section>
    </div>
</div>

<style>
/* ä¼šè©±ãƒ­ã‚°UI */
#chat-log {
    max-height: 70vh;
    overflow-y: auto;
    padding: 10px;
    background: rgba(0,0,0,.05);
    border-radius: 8px;
}
.msg {
    padding: 8px 10px;
    border-radius: 10px;
    margin: 6px 0;
    white-space: pre-wrap;
    font-family: monospace;
    font-size: 14px;
}
.msg.user {
    background: rgba(80,160,255,.15);
    border: 1px solid rgba(80,160,255,.35);
}
.msg.shogun {
    background: rgba(255,220,80,.12);
    border: 1px solid rgba(255,220,80,.30);
}
.msg.system {
    opacity: .75;
    font-style: italic;
}
</style>

<script>
// ãƒ¦ãƒ¼ã‚¶ãƒ¼å…¥åŠ›ãƒãƒ¼ã‚«ãƒ¼å®šæ•°
const USER_INPUT_MARKER = '\x1f';

// HTMLã‚¨ã‚¹ã‚±ãƒ¼ãƒ—é–¢æ•°ï¼ˆXSSå¯¾ç­–ï¼‰
function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// ãƒãƒ¼ã‚«ãƒ¼ãƒ™ãƒ¼ã‚¹ã®è‰²åˆ†ã‘é–¢æ•°
function colorizeOutput(text, color) {
    return text.split('\n').map(line => {
        if (line.startsWith(USER_INPUT_MARKER)) {
            // ãƒãƒ¼ã‚«ãƒ¼ä»˜ãè¡Œ = ãƒ¦ãƒ¼ã‚¶ãƒ¼å…¥åŠ›è¡Œ
            const content = line.substring(1);  // ãƒãƒ¼ã‚«ãƒ¼ã‚’é™¤å»
            return '<span style="color: ' + color + '">' + escapeHtml(content) + '</span>';
        }
        return escapeHtml(line);
    }).join('\n');
}

document.querySelectorAll('.tab-btn').forEach(btn => {
    btn.addEventListener('click', (e) => {
        e.preventDefault();
        e.stopPropagation();
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        btn.classList.add('active');
        document.getElementById('tab-' + btn.dataset.tab).classList.add('active');
        // å±¥æ­´ã‚¿ãƒ–: è‡ªå‹•æ›´æ–°ã—ãªã„ï¼ˆæ‰‹å‹•ã®ã€ŒğŸ”„ æ›´æ–°ã€ãƒœã‚¿ãƒ³ã§æ›´æ–°ï¼‰
    });
});

// Ctrl+Enter ã§é€ä¿¡
document.querySelector('textarea[name="instruction"]').addEventListener('keydown', (e) => {
    if (e.ctrlKey && e.key === 'Enter') {
        e.preventDefault();
        e.target.closest('form').requestSubmit();
    }
});

// Esc ã‚­ãƒ¼é€ä¿¡é–¢æ•°
function sendEscapeKey() {
    if (!confirm('Escã‚­ãƒ¼ã‚’å°†è»ã«é€ä¿¡ã—ã¾ã™ã‹ï¼Ÿ')) {
        return;
    }
    fetch('/api/special-key', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({key: 'Escape'})
    })
    .then(res => res.json())
    .then(data => {
        if (data.status === 'sent') {
            document.getElementById('command-result').innerHTML = '<p style="color:green;">Escã‚­ãƒ¼ã‚’é€ä¿¡ã—ã¾ã—ãŸ</p>';
        } else {
            document.getElementById('command-result').innerHTML = '<p style="color:red;">é€ä¿¡å¤±æ•—: ' + (data.message || 'Unknown error') + '</p>';
        }
    })
    .catch(err => {
        document.getElementById('command-result').innerHTML = '<p style="color:red;">é€ä¿¡ã‚¨ãƒ©ãƒ¼: ' + err + '</p>';
    });
}

// Esc ãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯
document.getElementById('esc-btn').addEventListener('click', sendEscapeKey);

// ãƒ–ãƒ©ã‚¦ã‚¶ã§Escã‚­ãƒ¼æŠ¼ä¸‹æ™‚
document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
        e.preventDefault();
        sendEscapeKey();
    }
});

// å±¥æ­´ã‚¿ãƒ–: ãƒˆã‚°ãƒ«ãƒœã‚¿ãƒ³ã®é–‹é–‰åˆ¶å¾¡ï¼ˆã‚¤ãƒ™ãƒ³ãƒˆå§”è­²ï¼‰
document.addEventListener('click', (e) => {
    if (e.target.classList.contains('toggle-btn')) {
        const content = e.target.nextElementSibling;
        if (content.style.display === 'none') {
            content.style.display = 'block';
            e.target.textContent = 'â–¼ éè¡¨ç¤º';
        } else {
            content.style.display = 'none';
            e.target.textContent = 'â–¶ è¡¨ç¤º';
        }
    }
    if (e.target.dataset && e.target.dataset.action === 'open-all') {
        document.querySelectorAll('.instruction-content').forEach(c => c.style.display = 'block');
        document.querySelectorAll('.toggle-btn').forEach(b => b.textContent = 'â–¼ éè¡¨ç¤º');
    }
    if (e.target.dataset && e.target.dataset.action === 'close-all') {
        document.querySelectorAll('.instruction-content').forEach(c => c.style.display = 'none');
        document.querySelectorAll('.toggle-btn').forEach(b => b.textContent = 'â–¶ è¡¨ç¤º');
    }
});

// ä¼šè©±ãƒ­ã‚°é–¢é€£å¤‰æ•°
const MAX_CHAT_LOG_MESSAGES = 200;

// ä¼šè©±ãƒ­ã‚°ã«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¿½åŠ ã™ã‚‹é–¢æ•°
function addChatMessage(text, className) {
    const chatLog = document.getElementById('chat-log');
    const msgDiv = document.createElement('div');
    msgDiv.className = 'msg ' + className;
    msgDiv.textContent = text;
    chatLog.appendChild(msgDiv);

    // ä¸Šé™ç®¡ç†ï¼šå¤ã„ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å‰Šé™¤
    while (chatLog.children.length > MAX_CHAT_LOG_MESSAGES) {
        chatLog.removeChild(chatLog.firstChild);
    }

    chatLog.scrollTop = chatLog.scrollHeight;
}

// rawå‡ºåŠ›ã‚’å…¨ç½®æ›ã™ã‚‹é–¢æ•°
function updateRawOutput(text) {
    const el = document.getElementById('shogun-output');
    el.innerHTML = '<pre>' + colorizeOutput(text, 'lightblue') + '</pre>';
}

// rawå‡ºåŠ›ã«è¿½è¨˜ã™ã‚‹é–¢æ•°
function appendToRawOutput(text) {
    const el = document.getElementById('shogun-output');
    const pre = el.querySelector('pre');
    if (pre) {
        // æ—¢å­˜ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã«è¿½è¨˜
        const currentHtml = pre.innerHTML;
        pre.innerHTML = currentHtml + '\n' + colorizeOutput(text, 'lightblue');
    } else {
        // preã‚¿ã‚°ãŒãªã„å ´åˆã¯æ–°è¦ä½œæˆ
        el.innerHTML = '<pre>' + colorizeOutput(text, 'lightblue') + '</pre>';
    }
}

// htmx afterRequest ã‚¤ãƒ™ãƒ³ãƒˆã§é€ä¿¡æˆåŠŸæ™‚ã«ä¼šè©±ãƒ­ã‚°ã«è¿½åŠ 
document.body.addEventListener('htmx:afterRequest', (e) => {
    if (e.detail.pathInfo.requestPath === '/api/command' && e.detail.successful) {
        const form = e.target;
        const textarea = form.querySelector('textarea[name="instruction"]');
        if (textarea && textarea.value.trim()) {
            addChatMessage(textarea.value.trim(), 'user');
        }
    }
});

// WebSocket ã§ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ å‡ºåŠ›ã‚’å—ä¿¡ï¼ˆæŒ‡æ®ã‚¿ãƒ–ï¼‰â€” delta å¯¾å¿œ
const ws = new WebSocket(`ws://${location.host}/ws`);
ws.onmessage = (e) => {
    const data = JSON.parse(e.data);
    const el = document.getElementById('shogun-output');
    const wasAtBottom = el.scrollHeight - el.scrollTop <= el.clientHeight + 50;

    if (data.type === 'noop') {
        return; // å¤‰æ›´ãªã—ã€ä½•ã‚‚ã—ãªã„
    }

    if (data.type === 'reset') {
        // ãƒ•ãƒ«å†é€ï¼šå…¨ç½®æ›
        const fullText = data.lines.join('\n');
        updateRawOutput(fullText);
        // ä¼šè©±ãƒ­ã‚°ã«ã¯æ–°ã—ã„ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¨ã—ã¦è¿½åŠ 
        if (fullText.trim()) {
            addChatMessage(fullText.trim(), 'shogun');
        }
        if (wasAtBottom) {
            el.scrollTop = el.scrollHeight;
        }
        return;
    }

    if (data.type === 'delta') {
        // å¢—åˆ†ï¼šæ–°ã—ã„è¡Œã‚’è¿½è¨˜
        const newText = data.lines.join('\n');
        if (newText.trim()) {
            appendToRawOutput(newText);
            addChatMessage(newText.trim(), 'shogun');
        }
        if (wasAtBottom) {
            el.scrollTop = el.scrollHeight;
        }
        return;
    }

    // å¾Œæ–¹äº’æ›: æ—§å½¢å¼ï¼ˆãƒ—ãƒ¬ãƒ¼ãƒ³ãƒ†ã‚­ã‚¹ãƒˆï¼‰ã®å ´åˆ
    if (data.output !== undefined) {
        // 10KBï¼ˆ10000æ–‡å­—ï¼‰ã‚’è¶…ãˆã‚‹å ´åˆã¯æœ«å°¾10KBã®ã¿ä½¿ç”¨
        let output = data.output;
        if (output.length > 10000) {
            output = output.slice(-10000);
        }
        updateRawOutput(output);
        if (output.trim()) {
            addChatMessage(output.trim(), 'shogun');
        }
        if (wasAtBottom) {
            el.scrollTop = el.scrollHeight;
        }
    }
};
ws.onclose = () => {
    document.getElementById('shogun-output').innerHTML = '<pre>æ¥ç¶šãŒåˆ‡æ–­ã•ã‚Œã¾ã—ãŸã€‚ãƒšãƒ¼ã‚¸ã‚’ãƒªãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„ã€‚</pre>';
};

// ç›£è¦–ã‚¿ãƒ–: å…¨ãƒšã‚¤ãƒ³ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ è¡¨ç¤ºï¼ˆdelta å¯¾å¿œï¼‰
const monitorPanes = {}; // ãƒšã‚¤ãƒ³å‡ºåŠ›ã®ãƒ­ãƒ¼ã‚«ãƒ«ã‚­ãƒ£ãƒƒã‚·ãƒ¥ï¼ˆè¡Œé…åˆ—ï¼‰

const monitorWs = new WebSocket(`ws://${location.host}/ws/monitor`);
monitorWs.onmessage = (e) => {
    const data = JSON.parse(e.data);
    if (data.type === 'monitor_update' && data.updates) {
        // delta å¯¾å¿œ: å¤‰æ›´ãŒã‚ã£ãŸpaneã®ã¿æ›´æ–°
        Object.entries(data.updates).forEach(([paneId, deltaResult]) => {
            if (deltaResult.type === 'reset') {
                // ãƒ•ãƒ«å†é€ï¼šå…¨ç½®æ›
                monitorPanes[paneId] = deltaResult.lines;
            } else if (deltaResult.type === 'delta') {
                // å¢—åˆ†ï¼šè¿½è¨˜
                if (!monitorPanes[paneId]) {
                    monitorPanes[paneId] = [];
                }
                monitorPanes[paneId].push(...deltaResult.lines);
                // è¡Œæ•°ä¸Šé™ãƒã‚§ãƒƒã‚¯: 5000è¡Œã‚’è¶…ãˆãŸã‚‰æœ«å°¾5000è¡Œã®ã¿ä¿æŒ
                if (monitorPanes[paneId].length > 5000) {
                    monitorPanes[paneId] = monitorPanes[paneId].slice(-5000);
                }
            }
            // noop ã®å ´åˆã¯ä½•ã‚‚ã—ãªã„
        });
        renderMonitorPanes(monitorPanes);
        return;
    }

    // å¾Œæ–¹äº’æ›: æ—§å½¢å¼ï¼ˆãƒ—ãƒ¬ãƒ¼ãƒ³ãƒ†ã‚­ã‚¹ãƒˆï¼‰ã®å ´åˆ
    if (data.updates) {
        Object.entries(data.updates).forEach(([paneId, output]) => {
            // æ—§å½¢å¼ã¯æ–‡å­—åˆ—ãªã®ã§è¡Œé…åˆ—ã«å¤‰æ›
            if (typeof output === 'string') {
                // 10KBï¼ˆ10000æ–‡å­—ï¼‰ã‚’è¶…ãˆã‚‹å ´åˆã¯æœ«å°¾10KBã®ã¿ä½¿ç”¨
                let processedOutput = output;
                if (output.length > 10000) {
                    processedOutput = output.slice(-10000);
                }
                monitorPanes[paneId] = processedOutput.split('\n');
            }
        });
        renderMonitorPanes(monitorPanes);
    }
};
monitorWs.onclose = () => {
    const grid = document.getElementById('monitor-grid');
    if (grid) grid.innerHTML = '<div class="monitor-loading">æ¥ç¶šãŒåˆ‡æ–­ã•ã‚Œã¾ã—ãŸã€‚ãƒšãƒ¼ã‚¸ã‚’ãƒªãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„ã€‚</div>';
};

// ãƒšã‚¤ãƒ³æç”»é–¢æ•°ï¼ˆdelta å¯¾å¿œ: è¡Œé…åˆ—ã‚’ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ï¼‰
function renderMonitorPanes(panes) {
    const grid = document.getElementById('monitor-grid');
    if (!grid) return;

    // ãƒšã‚¤ãƒ³IDã§ã‚½ãƒ¼ãƒˆã—ã¦å®‰å®šã—ãŸè¡¨ç¤ºé †ã‚’ç¶­æŒ
    const sortedPaneIds = Object.keys(panes).sort((a, b) => {
        const numA = parseInt(a.replace(/\D/g, ''), 10) || 0;
        const numB = parseInt(b.replace(/\D/g, ''), 10) || 0;
        return numA - numB;
    });

    grid.innerHTML = sortedPaneIds.map(paneId => {
        const lines = panes[paneId];
        // è¡Œé…åˆ—ã‚’æ–‡å­—åˆ—ã«å¤‰æ›
        const output = Array.isArray(lines) ? lines.join('\n') : lines;
        // colorizeOutput ã§ãƒãƒ¼ã‚«ãƒ¼ä»˜ãè¡Œã‚’ãƒ©ã‚¤ãƒˆãƒ–ãƒ«ãƒ¼ã«è‰²åˆ†ã‘
        const colorizedOutput = colorizeOutput(output, 'lightblue');
        return `
            <div class="pane-card" data-pane-id="${paneId}">
                <div class="pane-header">${paneId}</div>
                <div class="pane-output"><pre>${colorizedOutput}</pre></div>
            </div>
        `;
    }).join('');

    // å„ã‚«ãƒ¼ãƒ‰ã®è‡ªå‹•ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
    grid.querySelectorAll('.pane-output').forEach(el => {
        el.scrollTop = el.scrollHeight;
    });
}
</script>
{% endblock %}
