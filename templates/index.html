{% extends "base.html" %}

{% block content %}
<div class="container">
    <!-- ã‚¿ãƒ–ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ -->
    <nav class="tab-nav">
        <button type="button" class="tab-btn active" data-tab="command" hx-disable>æŒ‡æ®</button>
        <button type="button" class="tab-btn" data-tab="monitor" hx-disable>ç›£è¦–</button>
        <button type="button" class="tab-btn" data-tab="dashboard" hx-disable>æˆ¦æ³</button>
        <button type="button" class="tab-btn" data-tab="history" hx-disable>å±¥æ­´</button>
    </nav>

    <!-- ã‚¿ãƒ–1: æŒ‡æ® -->
    <div class="tab-content active" id="tab-command">
        <section class="command-input">
            <h2>ğŸ’¬ å°†è»ã¨ã®ä¼šè©±</h2>
            <form hx-post="/api/command" hx-target="#command-result" hx-swap="innerHTML"
                  hx-on::after-request="if(event.detail.successful) this.reset()">
                <textarea name="instruction" rows="5" placeholder="å°†è»ã«è©±ã—ã‹ã‘ã‚‹..."></textarea>
                <div class="btn-row">
                    <button type="submit">é€ä¿¡</button>
                    <button type="button" id="esc-btn" class="esc-btn">Esc</button>
                </div>
            </form>
            <div id="command-result"></div>
        </section>

        <!-- TUIæ“ä½œãƒ‘ãƒãƒ« -->
        <section class="tui-panel">
            <h2 class="tui-panel-toggle" id="tui-panel-toggle">
                <span id="tui-toggle-icon">â–¶</span> ğŸ® TUIæ“ä½œãƒ‘ãƒãƒ«
            </h2>
            <div class="tui-grid" id="tui-grid" style="display: none;">
                <!-- æ–¹å‘ã‚­ãƒ¼ -->
                <div class="tui-group">
                    <h3>æ–¹å‘ã‚­ãƒ¼</h3>
                    <div class="arrow-grid">
                        <button type="button" class="tui-key arrow-key" data-key="Up">â†‘</button>
                        <button type="button" class="tui-key arrow-key" data-key="Down">â†“</button>
                        <button type="button" class="tui-key arrow-key" data-key="Left">â†</button>
                        <button type="button" class="tui-key arrow-key" data-key="Right">â†’</button>
                    </div>
                </div>

                <!-- æ“ä½œãƒœã‚¿ãƒ³ -->
                <div class="tui-group">
                    <h3>æ“ä½œ</h3>
                    <div class="tui-buttons">
                        <button type="button" class="tui-key tui-key-critical" data-key="Enter">
                            <span class="btn-text">Enter</span>
                            <span class="progress-bar"></span>
                        </button>
                        <button type="button" class="tui-key tui-key-critical" data-key="Escape">
                            <span class="btn-text">Esc</span>
                            <span class="progress-bar"></span>
                        </button>
                        <button type="button" class="tui-key" data-key="Tab">Tab</button>
                        <button type="button" class="tui-key" data-key="BTab">Shift+Tab</button>
                        <button type="button" class="tui-key" data-key="Space">Space</button>
                        <button type="button" class="tui-key" data-key="BSpace">âŒ« Back</button>
                    </div>
                </div>

                <!-- æ•°å­—ã‚­ãƒ¼ -->
                <div class="tui-group">
                    <h3>æ•°å­—</h3>
                    <div class="number-grid">
                        <button type="button" class="tui-key number-key" data-key="1">1</button>
                        <button type="button" class="tui-key number-key" data-key="2">2</button>
                        <button type="button" class="tui-key number-key" data-key="3">3</button>
                        <button type="button" class="tui-key number-key" data-key="4">4</button>
                        <button type="button" class="tui-key number-key" data-key="5">5</button>
                        <button type="button" class="tui-key number-key" data-key="6">6</button>
                        <button type="button" class="tui-key number-key" data-key="7">7</button>
                        <button type="button" class="tui-key number-key" data-key="8">8</button>
                        <button type="button" class="tui-key number-key" data-key="9">9</button>
                        <button type="button" class="tui-key number-key" data-key="0">0</button>
                    </div>
                </div>

                <!-- Yes/No -->
                <div class="tui-group">
                    <h3>ç¢ºèª</h3>
                    <div class="tui-buttons">
                        <button type="button" class="tui-key yn-key tui-key-critical" data-key="y">
                            <span class="btn-text">âœ“ Yes (y)</span>
                            <span class="progress-bar"></span>
                        </button>
                        <button type="button" class="tui-key yn-key tui-key-critical" data-key="n">
                            <span class="btn-text">âœ— No (n)</span>
                            <span class="progress-bar"></span>
                        </button>
                    </div>
                </div>
            </div>
        </section>

        <section class="chat-log-section">
            <h2>ğŸ“ ä¼šè©±ãƒ­ã‚°</h2>
            <div id="chat-log"></div>
        </section>

        <details class="raw-output-details">
            <summary>ğŸ”„ tmux rawå‡ºåŠ›ï¼ˆæŠ˜ã‚ŠãŸãŸã¿ï¼‰<span id="shogun-ws-status" class="ws-status ws-status-connecting">æ¥ç¶šä¸­...</span>
            <button id="reconnect-shogun-btn" class="reconnect-shogun-btn reconnect-btn-hidden">å†æ¥ç¶š</button></summary>
            <div id="shogun-output" class="terminal"><pre>æ¥ç¶šä¸­...</pre></div>
        </details>
    </div>

    <!-- ã‚¿ãƒ–2: ç›£è¦– -->
    <div id="tab-monitor" class="tab-content">
        <section class="monitor-section">
        <h2>ğŸ‘ï¸ å…¨ãƒšã‚¤ãƒ³ç›£è¦–</h2>
        <div class="monitor-controls">
            <button id="clear-monitor-btn" class="clear-monitor-btn">ğŸ§¹ è¡¨ç¤ºã‚¯ãƒªã‚¢</button>
            <button id="reconnect-monitor-btn" class="reconnect-monitor-btn reconnect-btn-hidden">å†æ¥ç¶š</button>
            <span id="monitor-ws-status" class="ws-status ws-status-connecting">æ¥ç¶šä¸­...</span>
        </div>
        <div id="monitor-grid" class="monitor-grid">
            <!-- WebSocketã§å‹•çš„ã«ç”Ÿæˆ -->
            <div class="monitor-loading">æ¥ç¶šä¸­...</div>
        </div>
        </section>
    </div>

    <!-- ã‚¿ãƒ–3: æˆ¦æ³ -->
    <div class="tab-content" id="tab-dashboard">
        <section class="dashboard">
            <h2>ğŸ“Š ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</h2>
            <div class="dashboard-controls">
                <button type="button" id="dashboard-refresh-btn" class="dashboard-refresh-btn" hx-disable>æ›´æ–°</button>
                <button type="button" id="dashboard-mode-toggle" class="dashboard-mode-btn" data-mode="rendered" hx-disable>ğŸ“‹ Rendered</button>
            </div>
            <div id="dashboard-content">
                èª­ã¿è¾¼ã¿å¾…ã¡...
            </div>
        </section>
    </div>

    <!-- ã‚¿ãƒ–3: å±¥æ­´ -->
    <div class="tab-content" id="tab-history">
        <section class="command-history">
            <h2>ğŸ“œ ã‚³ãƒãƒ³ãƒ‰å±¥æ­´</h2>
            {% include "partials/history.html" %}
        </section>
    </div>
</div>

<!-- ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒœã‚¿ãƒ³ï¼ˆå…¨ã‚¿ãƒ–å…±é€šãƒ»å›ºå®šè¡¨ç¤ºï¼‰ -->
<div class="scroll-buttons" id="scroll-buttons">
    <button type="button" class="scroll-btn" id="scroll-top-btn" title="ä¸€ç•ªä¸Šã¸" aria-label="ä¸€ç•ªä¸Šã¸ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«" hx-disable>&#9650;</button>
    <button type="button" class="scroll-btn" id="scroll-bottom-btn" title="ä¸€ç•ªä¸‹ã¸" aria-label="ä¸€ç•ªä¸‹ã¸ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«" hx-disable>&#9660;</button>
</div>

<style>
/* ä¼šè©±ãƒ­ã‚°UI */
#chat-log {
    max-height: 70vh;
    overflow-y: auto;
    padding: 10px;
    background: rgba(0,0,0,.05);
    border-radius: 8px;
}
.msg {
    padding: 8px 10px;
    border-radius: 10px;
    margin: 6px 0;
    white-space: pre-wrap;
    font-family: monospace;
    font-size: 14px;
}
.msg.user {
    background: rgba(80,160,255,.15);
    border: 1px solid rgba(80,160,255,.35);
}
.msg.shogun {
    background: rgba(255,220,80,.12);
    border: 1px solid rgba(255,220,80,.30);
}
.msg.system {
    opacity: .75;
    font-style: italic;
}

/* ã‚¯ãƒªã‚¢ãƒœã‚¿ãƒ³ */
.clear-monitor-btn {
    margin: 0;
    padding: 8px 16px;
    background: rgba(255,100,100,0.1);
    border: 1px solid rgba(255,100,100,0.3);
    border-radius: 6px;
    cursor: pointer;
    font-size: 14px;
    font-weight: 800;
    transition: all 0.2s;
}
.clear-monitor-btn:hover {
    background: rgba(255,100,100,0.2);
    border-color: rgba(255,100,100,0.5);
}
</style>

<script>
// ãƒ¦ãƒ¼ã‚¶ãƒ¼å…¥åŠ›ãƒãƒ¼ã‚«ãƒ¼å®šæ•°
const USER_INPUT_MARKER = '\x1f';

// HTMLã‚¨ã‚¹ã‚±ãƒ¼ãƒ—é–¢æ•°ï¼ˆXSSå¯¾ç­–ï¼‰
function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// ãƒãƒ¼ã‚«ãƒ¼ãƒ™ãƒ¼ã‚¹ã®è‰²åˆ†ã‘é–¢æ•°
function colorizeOutput(text, color) {
    return text.split('\n').map(line => {
        if (line.startsWith(USER_INPUT_MARKER)) {
            // ãƒãƒ¼ã‚«ãƒ¼ä»˜ãè¡Œ = ãƒ¦ãƒ¼ã‚¶ãƒ¼å…¥åŠ›è¡Œ
            const content = line.substring(1);  // ãƒãƒ¼ã‚«ãƒ¼ã‚’é™¤å»
            return '<span style="color: ' + color + '">' + escapeHtml(content) + '</span>';
        }
        return escapeHtml(line);
    }).join('\n');
}

document.querySelectorAll('.tab-btn').forEach(btn => {
    btn.addEventListener('click', (e) => {
        e.preventDefault();
        e.stopPropagation();
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        btn.classList.add('active');
        document.getElementById('tab-' + btn.dataset.tab).classList.add('active');
        // å±¥æ­´ã‚¿ãƒ–: è‡ªå‹•æ›´æ–°ã—ãªã„ï¼ˆæ‰‹å‹•ã®ã€ŒğŸ”„ æ›´æ–°ã€ãƒœã‚¿ãƒ³ã§æ›´æ–°ï¼‰
    });
});

// Ctrl+Enter ã§é€ä¿¡
document.querySelector('textarea[name="instruction"]').addEventListener('keydown', (e) => {
    if (e.ctrlKey && e.key === 'Enter') {
        e.preventDefault();
        e.target.closest('form').requestSubmit();
    }
});

// Esc ã‚­ãƒ¼é€ä¿¡é–¢æ•°
function sendEscapeKey() {
    if (!confirm('Escã‚­ãƒ¼ã‚’å°†è»ã«é€ä¿¡ã—ã¾ã™ã‹ï¼Ÿ')) {
        return;
    }
    fetch('/api/special-key', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({key: 'Escape'})
    })
    .then(res => res.json())
    .then(data => {
        if (data.status === 'sent') {
            document.getElementById('command-result').innerHTML = '<p style="color:green;">Escã‚­ãƒ¼ã‚’é€ä¿¡ã—ã¾ã—ãŸ</p>';
        } else {
            document.getElementById('command-result').innerHTML = '<p style="color:red;">é€ä¿¡å¤±æ•—: ' + (data.message || 'Unknown error') + '</p>';
        }
    })
    .catch(err => {
        document.getElementById('command-result').innerHTML = '<p style="color:red;">é€ä¿¡ã‚¨ãƒ©ãƒ¼: ' + err + '</p>';
    });
}

// Esc ãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯
document.getElementById('esc-btn').addEventListener('click', sendEscapeKey);

// ãƒ–ãƒ©ã‚¦ã‚¶ã§Escã‚­ãƒ¼æŠ¼ä¸‹æ™‚
document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
        e.preventDefault();
        sendEscapeKey();
    }
});

// TUIæ“ä½œãƒ‘ãƒãƒ«: æ±ç”¨ã‚­ãƒ¼é€ä¿¡é–¢æ•°
function sendTuiKey(key) {
    fetch('/api/special-key', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({key: key})
    })
    .then(res => res.json())
    .then(data => {
        if (data.status === 'sent') {
            document.getElementById('command-result').innerHTML = '<p style="color:green;">ã‚­ãƒ¼ã€Œ' + key + 'ã€ã‚’é€ä¿¡ã—ã¾ã—ãŸ</p>';
        } else {
            document.getElementById('command-result').innerHTML = '<p style="color:red;">é€ä¿¡å¤±æ•—: ' + (data.message || 'Unknown error') + '</p>';
        }
    })
    .catch(err => {
        document.getElementById('command-result').innerHTML = '<p style="color:red;">é€ä¿¡ã‚¨ãƒ©ãƒ¼: ' + err + '</p>';
    });
}

// TUIæ“ä½œãƒ‘ãƒãƒ«: æŠ˜ã‚Šç•³ã¿æ©Ÿèƒ½
document.getElementById('tui-panel-toggle').addEventListener('click', (e) => {
    const grid = document.getElementById('tui-grid');
    const icon = document.getElementById('tui-toggle-icon');
    if (grid.style.display === 'none') {
        grid.style.display = 'grid';
        icon.textContent = 'â–¼';
    } else {
        grid.style.display = 'none';
        icon.textContent = 'â–¶';
    }
});

// TUIæ“ä½œãƒ‘ãƒãƒ«: é•·æŠ¼ã—ç¢ºèªæ©Ÿèƒ½ï¼ˆæ±ºå®šç³»ãƒœã‚¿ãƒ³ï¼‰
const HOLD_DURATION = 1000; // 1ç§’
const holdTimers = new Map();

document.querySelectorAll('.tui-key').forEach(btn => {
    const key = btn.getAttribute('data-key');
    if (!key) return;

    const isCritical = btn.classList.contains('tui-key-critical');

    if (isCritical) {
        // æ±ºå®šç³»ãƒœã‚¿ãƒ³: é•·æŠ¼ã—ï¼ˆ1ç§’ï¼‰ã§ç™ºå‹•
        let pressStartTime = 0;
        let holdTimer = null;
        const progressBar = btn.querySelector('.progress-bar');

        btn.addEventListener('mousedown', (e) => {
            e.preventDefault();
            pressStartTime = Date.now();
            btn.classList.add('holding');

            holdTimer = setTimeout(() => {
                sendTuiKey(key);
                btn.classList.remove('holding');
                btn.classList.add('activated');
                setTimeout(() => btn.classList.remove('activated'), 300);
            }, HOLD_DURATION);
        });

        btn.addEventListener('mouseup', (e) => {
            e.preventDefault();
            if (holdTimer) {
                clearTimeout(holdTimer);
                holdTimer = null;
            }
            btn.classList.remove('holding');
        });

        btn.addEventListener('mouseleave', (e) => {
            if (holdTimer) {
                clearTimeout(holdTimer);
                holdTimer = null;
            }
            btn.classList.remove('holding');
        });

        // ã‚¿ãƒƒãƒãƒ‡ãƒã‚¤ã‚¹å¯¾å¿œ
        btn.addEventListener('touchstart', (e) => {
            e.preventDefault();
            pressStartTime = Date.now();
            btn.classList.add('holding');

            holdTimer = setTimeout(() => {
                sendTuiKey(key);
                btn.classList.remove('holding');
                btn.classList.add('activated');
                setTimeout(() => btn.classList.remove('activated'), 300);
            }, HOLD_DURATION);
        });

        btn.addEventListener('touchend', (e) => {
            e.preventDefault();
            if (holdTimer) {
                clearTimeout(holdTimer);
                holdTimer = null;
            }
            btn.classList.remove('holding');
        });
    } else {
        // é€šå¸¸ãƒœã‚¿ãƒ³: å³åº§ã«ç™ºå‹•
        btn.addEventListener('click', (e) => {
            sendTuiKey(key);
        });
    }
});

// å±¥æ­´ã‚¿ãƒ–: ãƒˆã‚°ãƒ«ãƒœã‚¿ãƒ³ã®é–‹é–‰åˆ¶å¾¡ï¼ˆã‚¤ãƒ™ãƒ³ãƒˆå§”è­²ï¼‰
document.addEventListener('click', (e) => {
    if (e.target.classList.contains('toggle-btn')) {
        const content = e.target.nextElementSibling;
        if (content.style.display === 'none') {
            content.style.display = 'block';
            e.target.textContent = 'â–¼ éè¡¨ç¤º';
        } else {
            content.style.display = 'none';
            e.target.textContent = 'â–¶ è¡¨ç¤º';
        }
    }
    if (e.target.dataset && e.target.dataset.action === 'open-all') {
        document.querySelectorAll('.instruction-content').forEach(c => c.style.display = 'block');
        document.querySelectorAll('.toggle-btn').forEach(b => b.textContent = 'â–¼ éè¡¨ç¤º');
    }
    if (e.target.dataset && e.target.dataset.action === 'close-all') {
        document.querySelectorAll('.instruction-content').forEach(c => c.style.display = 'none');
        document.querySelectorAll('.toggle-btn').forEach(b => b.textContent = 'â–¶ è¡¨ç¤º');
    }
});

// ä¼šè©±ãƒ­ã‚°é–¢é€£å¤‰æ•°
const MAX_CHAT_LOG_MESSAGES = 200;

// ä¼šè©±ãƒ­ã‚°ã«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¿½åŠ ã™ã‚‹é–¢æ•°
function addChatMessage(text, className) {
    const chatLog = document.getElementById('chat-log');
    const msgDiv = document.createElement('div');
    msgDiv.className = 'msg ' + className;
    msgDiv.textContent = text;
    chatLog.appendChild(msgDiv);

    // ä¸Šé™ç®¡ç†ï¼šå¤ã„ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å‰Šé™¤
    while (chatLog.children.length > MAX_CHAT_LOG_MESSAGES) {
        chatLog.removeChild(chatLog.firstChild);
    }

    chatLog.scrollTop = chatLog.scrollHeight;
}

// rawå‡ºåŠ›ã‚’å…¨ç½®æ›ã™ã‚‹é–¢æ•°
function updateRawOutput(text) {
    const el = document.getElementById('shogun-output');
    el.innerHTML = '<pre>' + colorizeOutput(text, 'lightblue') + '</pre>';
}

// rawå‡ºåŠ›ã«è¿½è¨˜ã™ã‚‹é–¢æ•°
function appendToRawOutput(text) {
    const el = document.getElementById('shogun-output');
    const pre = el.querySelector('pre');
    if (pre) {
        // æ—¢å­˜ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã«è¿½è¨˜
        const currentHtml = pre.innerHTML;
        pre.innerHTML = currentHtml + '\n' + colorizeOutput(text, 'lightblue');
    } else {
        // preã‚¿ã‚°ãŒãªã„å ´åˆã¯æ–°è¦ä½œæˆ
        el.innerHTML = '<pre>' + colorizeOutput(text, 'lightblue') + '</pre>';
    }
}

// htmx afterRequest ã‚¤ãƒ™ãƒ³ãƒˆã§é€ä¿¡æˆåŠŸæ™‚ã«ä¼šè©±ãƒ­ã‚°ã«è¿½åŠ 
document.body.addEventListener('htmx:afterRequest', (e) => {
    if (e.detail.pathInfo.requestPath === '/api/command' && e.detail.successful) {
        const form = e.target;
        const textarea = form.querySelector('textarea[name="instruction"]');
        if (textarea && textarea.value.trim()) {
            addChatMessage(textarea.value.trim(), 'user');
        }
    }
});

// ===========================================================
// ReconnectingWebSocket: æ®¿ã®æœ€çµ‚ç¢ºå®šä»•æ§˜æº–æ‹ 
// - onclose ã®ã¿ã«ã‚ˆã‚‹åˆ‡æ–­åˆ¤å®šï¼ˆAæ–¹å¼ï¼‰
// - ãƒªãƒˆãƒ©ã‚¤ä¸Šé™3å›ã€ã‚¨ã‚¯ã‚¹ãƒãƒãƒ³ã‚·ãƒ£ãƒ«ãƒãƒƒã‚¯ã‚ªãƒ•(1s->30s)
// - UIè¡¨ç¤ºé…å»¶ã«ã‚ˆã‚‹ç¬æ–­éè¡¨ç¤º
// - é–¾å€¤ã¯å…¨ã¦ /api/ws-config ã‹ã‚‰å–å¾—ï¼ˆãƒãƒ¼ãƒ‰ã‚³ãƒ¼ãƒ‰ç¦æ­¢ï¼‰
// ===========================================================
class ReconnectingWebSocket {
    constructor(url, opts = {}) {
        this.url = url;
        this.onmessage = opts.onmessage || null;
        this.onstatuschange = opts.onstatuschange || null;
        this._baseDelay = opts.baseDelay || 1000;
        this._maxDelay = opts.maxDelay || 30000;
        this._maxRetries = opts.maxRetries || 3;
        this._uiDelayMs = opts.uiDelayMs || 0;          // UIè¡¨ç¤ºé…å»¶é–¾å€¤
        this._currentDelay = this._baseDelay;
        this._retryCount = 0;
        this._reconnectTimer = null;
        this._uiDelayTimer = null;
        this._ws = null;
        this._intentionalClose = false;
        this._internalState = 'connecting';  // å†…éƒ¨çŠ¶æ…‹
        this._statusElementId = opts.statusElementId || null;
        this._reconnectBtnId = opts.reconnectBtnId || null;
        this.connect();
    }

    connect() {
        this._clearReconnectTimer();
        // æ—¢å­˜ã®WebSocketãŒã‚ã‚Œã°é–‰ã˜ã‚‹
        if (this._ws) {
            this._intentionalClose = true;
            try { this._ws.close(); } catch (e) { /* ignore */ }
            this._ws = null;
        }
        this._intentionalClose = false;
        this._internalState = 'connecting';
        this._updateUI('connecting');
        try {
            this._ws = new WebSocket(this.url);
        } catch (err) {
            this._handleDisconnect();
            return;
        }

        this._ws.onopen = () => {
            this._currentDelay = this._baseDelay;
            this._retryCount = 0;
            this._internalState = 'connected';
            // ç¬æ–­ä¸­ã®UIé…å»¶ã‚¿ã‚¤ãƒãƒ¼ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«ï¼ˆç¬æ–­ã‚’UIä¸Šå®Œå…¨ç„¡è¦–ï¼‰
            this._clearUiDelayTimer();
            this._updateUI('connected');
            this._hideReconnectBtn();
        };

        this._ws.onmessage = (e) => {
            if (this.onmessage) this.onmessage(e);
        };

        this._ws.onclose = () => {
            // onclose ã«ã‚ˆã‚‹åˆ‡æ–­åˆ¤å®šï¼ˆAæ–¹å¼ã®ã¿ï¼‰
            if (!this._intentionalClose) {
                this._handleDisconnect();
            }
        };
    }

    reconnect() {
        // æ‰‹å‹•å†æ¥ç¶š: ãƒªãƒˆãƒ©ã‚¤ã‚«ã‚¦ãƒ³ãƒˆãƒªã‚»ãƒƒãƒˆ
        this._clearReconnectTimer();
        this._clearUiDelayTimer();
        this._retryCount = 0;
        this._currentDelay = this._baseDelay;
        if (this._ws) {
            this._intentionalClose = true;
            try { this._ws.close(); } catch (e) { /* ignore */ }
            this._ws = null;
        }
        this.connect();
    }

    _handleDisconnect() {
        this._internalState = 'disconnected';

        // ãƒªãƒˆãƒ©ã‚¤ä¸Šé™ãƒã‚§ãƒƒã‚¯
        if (this._retryCount >= this._maxRetries) {
            // ãƒªãƒˆãƒ©ã‚¤ä¸Šé™åˆ°é”: è‡ªå‹•å†æ¥ç¶šåœæ­¢
            this._clearUiDelayTimer();
            this._updateUI('failed');
            this._showReconnectBtn();
            return;
        }

        // UIè¡¨ç¤º: é–¾å€¤æ™‚é–“çµŒéå¾Œã®ã¿ã€Œåˆ‡æ–­ã€è¡¨ç¤ºï¼ˆç¬æ–­ã¯ç„¡è¦–ï¼‰
        this._startUiDelayTimer();

        // è‡ªå‹•å†æ¥ç¶šã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«
        this._scheduleReconnect();
    }

    _scheduleReconnect() {
        this._clearReconnectTimer();
        this._retryCount++;
        const delay = this._currentDelay;
        this._reconnectTimer = setTimeout(() => {
            this._currentDelay = Math.min(this._currentDelay * 2, this._maxDelay);
            // å†æ¥ç¶šè©¦è¡Œä¸­ã¯UIæ›´æ–°
            this._clearUiDelayTimer();
            this._updateUI('reconnecting');
            this.connect();
        }, delay);
    }

    _startUiDelayTimer() {
        this._clearUiDelayTimer();
        if (this._uiDelayMs > 0) {
            this._uiDelayTimer = setTimeout(() => {
                this._uiDelayTimer = null;
                // é–¾å€¤çµŒéå¾Œã‚‚ã¾ã åˆ‡æ–­çŠ¶æ…‹ãªã‚‰ã€Œåˆ‡æ–­ã€è¡¨ç¤º
                if (this._internalState === 'disconnected') {
                    this._updateUI('disconnected');
                }
            }, this._uiDelayMs);
        } else {
            // uiDelayMs=0 ã®å ´åˆã¯å³åº§ã«è¡¨ç¤º
            this._updateUI('disconnected');
        }
    }

    _clearReconnectTimer() {
        if (this._reconnectTimer) {
            clearTimeout(this._reconnectTimer);
            this._reconnectTimer = null;
        }
    }

    _clearUiDelayTimer() {
        if (this._uiDelayTimer) {
            clearTimeout(this._uiDelayTimer);
            this._uiDelayTimer = null;
        }
    }

    _updateUI(displayStatus) {
        const el = this._statusElementId ? document.getElementById(this._statusElementId) : null;
        if (!el) return;

        el.className = 'ws-status';
        switch (displayStatus) {
            case 'connecting':
                el.className += ' ws-status-connecting';
                el.textContent = 'æ¥ç¶šä¸­...';
                break;
            case 'connected':
                el.className += ' ws-status-connected';
                el.textContent = '';
                break;
            case 'disconnected':
                el.className += ' ws-status-disconnected';
                el.textContent = 'åˆ‡æ–­';
                break;
            case 'reconnecting':
                el.className += ' ws-status-reconnecting';
                el.textContent = 'å†æ¥ç¶šä¸­...';
                break;
            case 'failed':
                el.className += ' ws-status-failed';
                el.textContent = 'æ¥ç¶šãŒåˆ‡æ–­ã•ã‚Œã¾ã—ãŸ';
                break;
        }

        if (this.onstatuschange) {
            this.onstatuschange(displayStatus);
        }
    }

    _showReconnectBtn() {
        const btn = this._reconnectBtnId ? document.getElementById(this._reconnectBtnId) : null;
        if (btn) btn.classList.remove('reconnect-btn-hidden');
    }

    _hideReconnectBtn() {
        const btn = this._reconnectBtnId ? document.getElementById(this._reconnectBtnId) : null;
        if (btn) btn.classList.add('reconnect-btn-hidden');
    }

    get readyState() {
        return this._ws ? this._ws.readyState : WebSocket.CLOSED;
    }
}

// ===========================================================
// WebSocketåˆæœŸåŒ–: /api/ws-config ã‹ã‚‰è¨­å®šå–å¾—å¾Œã«æ¥ç¶šé–‹å§‹
// ===========================================================
const monitorPanes = {}; // ãƒšã‚¤ãƒ³å‡ºåŠ›ã®ãƒ­ãƒ¼ã‚«ãƒ«ã‚­ãƒ£ãƒƒã‚·ãƒ¥ï¼ˆè¡Œé…åˆ—ï¼‰
let shogunWs = null;
let monitorWs = null;

(async function initWebSockets() {
    // è¨­å®šå€¤å–å¾—ï¼ˆå…¨é–¾å€¤ã¯settings.yamlã‹ã‚‰ç®—å‡ºã€ãƒãƒ¼ãƒ‰ã‚³ãƒ¼ãƒ‰ç¦æ­¢ï¼‰
    let wsConfig;
    try {
        const res = await fetch('/api/ws-config');
        wsConfig = await res.json();
    } catch (e) {
        // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: APIå¤±æ•—æ™‚ã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ï¼ˆsettings.yamlã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¨åŒã˜ï¼‰
        wsConfig = {
            monitor: { base_interval_ms: 5000, max_interval_ms: 10000 },
            shogun: { base_interval_ms: 1000, max_interval_ms: 3000 }
        };
    }

    // é–¾å€¤ç®—å‡ºï¼ˆsettings.yamlã‹ã‚‰å–å¾—ã€ãƒãƒ¼ãƒ‰ã‚³ãƒ¼ãƒ‰ç¦æ­¢ï¼‰
    // æŒ‡æ®ã‚¿ãƒ–(shogun): uiDelay = max_interval_msï¼ˆç¬æ–­ç„¡è¦–ã®é–¾å€¤ï¼‰
    const shogunUiDelayMs = wsConfig.shogun.max_interval_ms;

    // ç›£è¦–ã‚¿ãƒ–(monitor): uiDelay = base_interval_msï¼ˆç¬æ–­ç„¡è¦–ã®é–¾å€¤ï¼‰
    const monitorUiDelayMs = wsConfig.monitor.base_interval_ms;

    // æŒ‡æ®ã‚¿ãƒ– WebSocket
    shogunWs = new ReconnectingWebSocket(`ws://${location.host}/ws`, {
        uiDelayMs: shogunUiDelayMs,
        maxRetries: 3,
        statusElementId: 'shogun-ws-status',
        reconnectBtnId: 'reconnect-shogun-btn',
        onmessage: (e) => {
            const data = JSON.parse(e.data);
            const el = document.getElementById('shogun-output');
            const wasAtBottom = el.scrollHeight - el.scrollTop <= el.clientHeight + 50;

            if (data.type === 'noop') {
                return;
            }

            if (data.type === 'reset') {
                const fullText = data.lines.join('\n');
                updateRawOutput(fullText);
                if (fullText.trim()) {
                    addChatMessage(fullText.trim(), 'shogun');
                }
                if (wasAtBottom) {
                    el.scrollTop = el.scrollHeight;
                }
                return;
            }

            if (data.type === 'delta') {
                const newText = data.lines.join('\n');
                if (newText.trim()) {
                    appendToRawOutput(newText);
                    addChatMessage(newText.trim(), 'shogun');
                }
                if (wasAtBottom) {
                    el.scrollTop = el.scrollHeight;
                }
                return;
            }

            if (data.output !== undefined) {
                let output = data.output;
                if (output.length > 10000) {
                    output = output.slice(-10000);
                }
                updateRawOutput(output);
                if (output.trim()) {
                    addChatMessage(output.trim(), 'shogun');
                }
                if (wasAtBottom) {
                    el.scrollTop = el.scrollHeight;
                }
            }
        },
        onstatuschange: (status) => {
            // åˆ‡æ–­æ™‚: æ—¢å­˜ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã¯ä¿æŒï¼ˆç™½ç”»é¢ã«ã—ãªã„ï¼‰
        }
    });

    // ç›£è¦–ã‚¿ãƒ– WebSocket
    monitorWs = new ReconnectingWebSocket(`ws://${location.host}/ws/monitor`, {
        uiDelayMs: monitorUiDelayMs,
        maxRetries: 3,
        statusElementId: 'monitor-ws-status',
        reconnectBtnId: 'reconnect-monitor-btn',
        onmessage: (e) => {
            const data = JSON.parse(e.data);
            if (data.type === 'monitor_update' && data.updates) {
                Object.entries(data.updates).forEach(([paneId, deltaResult]) => {
                    if (deltaResult.type === 'reset') {
                        monitorPanes[paneId] = deltaResult.lines;
                    } else if (deltaResult.type === 'delta') {
                        if (!monitorPanes[paneId]) {
                            monitorPanes[paneId] = [];
                        }
                        monitorPanes[paneId].push(...deltaResult.lines);
                        if (monitorPanes[paneId].length > 5000) {
                            monitorPanes[paneId] = monitorPanes[paneId].slice(-5000);
                        }
                    }
                });
                renderMonitorPanes(monitorPanes);
                return;
            }

            if (data.updates) {
                Object.entries(data.updates).forEach(([paneId, output]) => {
                    if (typeof output === 'string') {
                        let processedOutput = output;
                        if (output.length > 10000) {
                            processedOutput = output.slice(-10000);
                        }
                        monitorPanes[paneId] = processedOutput.split('\n');
                    }
                });
                renderMonitorPanes(monitorPanes);
            }
        },
        onstatuschange: (status) => {
            // åˆ‡æ–­æ™‚: monitorPanes ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ä¿æŒã—ã€æ—¢å­˜ã‚«ãƒ¼ãƒ‰ã‚’ãã®ã¾ã¾è¡¨ç¤º
        }
    });

    // å†æ¥ç¶šãƒœã‚¿ãƒ³: æ‰‹å‹•å†æ¥ç¶š
    document.getElementById('reconnect-shogun-btn').addEventListener('click', () => {
        if (shogunWs) shogunWs.reconnect();
    });

    document.getElementById('reconnect-monitor-btn').addEventListener('click', () => {
        if (monitorWs) monitorWs.reconnect();
    });
})();

// ãƒšã‚¤ãƒ³æç”»é–¢æ•°ï¼ˆdelta å¯¾å¿œ: è¡Œé…åˆ—ã‚’ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ï¼‰
function renderMonitorPanes(panes) {
    const grid = document.getElementById('monitor-grid');
    if (!grid) return;

    // ãƒšã‚¤ãƒ³IDã§ã‚½ãƒ¼ãƒˆã—ã¦å®‰å®šã—ãŸè¡¨ç¤ºé †ã‚’ç¶­æŒ
    const sortedPaneIds = Object.keys(panes).sort((a, b) => {
        const numA = parseInt(a.replace(/\D/g, ''), 10) || 0;
        const numB = parseInt(b.replace(/\D/g, ''), 10) || 0;
        return numA - numB;
    });

    grid.innerHTML = sortedPaneIds.map(paneId => {
        const lines = panes[paneId];
        // è¡Œé…åˆ—ã‚’æ–‡å­—åˆ—ã«å¤‰æ›
        const output = Array.isArray(lines) ? lines.join('\n') : lines;
        // colorizeOutput ã§ãƒãƒ¼ã‚«ãƒ¼ä»˜ãè¡Œã‚’ãƒ©ã‚¤ãƒˆãƒ–ãƒ«ãƒ¼ã«è‰²åˆ†ã‘
        const colorizedOutput = colorizeOutput(output, 'lightblue');
        return `
            <div class="pane-card" data-pane-id="${paneId}">
                <div class="pane-header">${paneId}</div>
                <div class="pane-output"><pre>${colorizedOutput}</pre></div>
            </div>
        `;
    }).join('');

    // å„ã‚«ãƒ¼ãƒ‰ã®è‡ªå‹•ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
    grid.querySelectorAll('.pane-output').forEach(el => {
        el.scrollTop = el.scrollHeight;
    });
}

// ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒœã‚¿ãƒ³: ä¸€ç•ªä¸Š/ä¸€ç•ªä¸‹ã¸ã‚¹ãƒ ãƒ¼ã‚¹ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
document.getElementById('scroll-top-btn').addEventListener('click', () => {
    window.scrollTo({ top: 0, behavior: 'smooth' });
});
document.getElementById('scroll-bottom-btn').addEventListener('click', () => {
    window.scrollTo({ top: document.documentElement.scrollHeight, behavior: 'smooth' });
});

// ===========================================================
// ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰: Markdownæ•´å½¢è¡¨ç¤ºãƒˆã‚°ãƒ«
// ===========================================================
let dashboardMode = 'rendered'; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: Rendered ãƒ¢ãƒ¼ãƒ‰

function applyDashboardMode() {
    const rawDataEl = document.getElementById('dashboard-raw-data');
    const displayEl = document.getElementById('dashboard-display');
    if (!rawDataEl || !displayEl) return;

    const rawText = rawDataEl.textContent;

    if (dashboardMode === 'rendered') {
        // marked.js ã§ãƒ‘ãƒ¼ã‚¹ã—ã¦æ•´å½¢HTMLè¡¨ç¤º
        displayEl.className = 'markdown-body';
        displayEl.innerHTML = marked.parse(rawText);
    } else {
        // ç”Ÿãƒ†ã‚­ã‚¹ãƒˆè¡¨ç¤º
        displayEl.className = '';
        const pre = document.createElement('pre');
        pre.textContent = rawText;
        displayEl.innerHTML = '';
        displayEl.appendChild(pre);
    }
}

// ãƒˆã‚°ãƒ«ãƒœã‚¿ãƒ³
document.getElementById('dashboard-mode-toggle').addEventListener('click', () => {
    const btn = document.getElementById('dashboard-mode-toggle');
    if (dashboardMode === 'rendered') {
        dashboardMode = 'raw';
        btn.textContent = 'ğŸ“„ Raw';
        btn.dataset.mode = 'raw';
    } else {
        dashboardMode = 'rendered';
        btn.textContent = 'ğŸ“‹ Rendered';
        btn.dataset.mode = 'rendered';
    }
    applyDashboardMode();
});

// ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰æ‰‹å‹•æ›´æ–°: fetchã—ã¦è¡¨ç¤ºã‚’æ›´æ–°
function refreshDashboard() {
    const btn = document.getElementById('dashboard-refresh-btn');
    btn.disabled = true;
    btn.textContent = 'æ›´æ–°ä¸­...';

    fetch('/api/dashboard')
        .then(res => {
            if (!res.ok) throw new Error('HTTP ' + res.status);
            return res.text();
        })
        .then(html => {
            document.getElementById('dashboard-content').innerHTML = html;
            applyDashboardMode();
        })
        .catch(err => {
            document.getElementById('dashboard-content').innerHTML =
                '<pre>Error: ' + escapeHtml(String(err)) + '</pre>';
        })
        .finally(() => {
            btn.disabled = false;
            btn.textContent = 'æ›´æ–°';
        });
}

// æ›´æ–°ãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯
document.getElementById('dashboard-refresh-btn').addEventListener('click', refreshDashboard);

// åˆå›è¡¨ç¤º: ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã‚¿ãƒ–ãŒè¡¨ç¤ºã•ã‚ŒãŸã‚‰ä¸€åº¦ã ã‘fetch
let dashboardInitialLoaded = false;
document.querySelectorAll('.tab-btn').forEach(btn => {
    btn.addEventListener('click', () => {
        if (btn.dataset.tab === 'dashboard' && !dashboardInitialLoaded) {
            dashboardInitialLoaded = true;
            refreshDashboard();
        }
    });
});

// ã‚¯ãƒªã‚¢ãƒœã‚¿ãƒ³: å…¨ãƒšã‚¤ãƒ³ã®è¡¨ç¤ºå±¥æ­´ã‚’æ¶ˆå»ï¼ˆãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆæ–¹å¼ï¼‰
document.getElementById('clear-monitor-btn').addEventListener('click', () => {
    fetch('/api/monitor/clear', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'}
    })
    .then(res => res.json())
    .then(data => {
        if (data.status === 'cleared') {
            // ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ãŒã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆä¿å­˜å®Œäº†
            // ãƒ­ãƒ¼ã‚«ãƒ«ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ã‚¯ãƒªã‚¢
            Object.keys(monitorPanes).forEach(key => {
                monitorPanes[key] = [];
            });
            renderMonitorPanes(monitorPanes);
        } else {
            console.error('Clear failed:', data.message);
        }
    })
    .catch(err => {
        console.error('Clear error:', err);
    });
});

</script>
{% endblock %}
