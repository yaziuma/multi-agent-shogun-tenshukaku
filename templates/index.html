{% extends "base.html" %}

{% block content %}
<div class="container">
    <!-- ã‚¿ãƒ–ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ -->
    <nav class="tab-nav">
        <button type="button" class="tab-btn active" data-tab="command" hx-disable>æŒ‡æ®</button>
        <button type="button" class="tab-btn" data-tab="monitor" hx-disable>ç›£è¦–</button>
        <button type="button" class="tab-btn" data-tab="dashboard" hx-disable>æˆ¦æ³</button>
        <button type="button" class="tab-btn" data-tab="history" hx-disable>å±¥æ­´</button>
    </nav>

    <!-- ã‚¿ãƒ–1: æŒ‡æ® -->
    <div class="tab-content active" id="tab-command">
        <section class="command-input">
            <h2>ğŸ’¬ å°†è»ã¨ã®ä¼šè©±</h2>
            <form hx-post="/api/command" hx-target="#command-result" hx-swap="innerHTML"
                  hx-on::after-request="if(event.detail.successful) this.reset()">
                <textarea name="instruction" rows="5" placeholder="å°†è»ã«è©±ã—ã‹ã‘ã‚‹..."></textarea>
                <div class="btn-row">
                    <button type="submit">é€ä¿¡</button>
                    <button type="button" id="esc-btn" class="esc-btn">Esc</button>
                </div>
            </form>
            <div id="command-result"></div>
        </section>

        <section class="realtime-output">
            <h2>ğŸ”„ ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ å‡ºåŠ›</h2>
            <p class="description">å°†è»ãƒšã‚¤ãƒ³ï¼ˆtmuxï¼‰ã®å‡ºåŠ›ã‚’ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ è¡¨ç¤º</p>
            <div id="shogun-output" class="terminal"><pre>æ¥ç¶šä¸­...</pre></div>
        </section>
    </div>

    <!-- ã‚¿ãƒ–2: ç›£è¦– -->
    <div id="tab-monitor" class="tab-content">
        <section class="monitor-section">
        <h2>ğŸ‘ï¸ å…¨ãƒšã‚¤ãƒ³ç›£è¦–</h2>
        <div id="monitor-grid" class="monitor-grid">
            <!-- WebSocketã§å‹•çš„ã«ç”Ÿæˆ -->
            <div class="monitor-loading">æ¥ç¶šä¸­...</div>
        </div>
        </section>
    </div>

    <!-- ã‚¿ãƒ–3: æˆ¦æ³ -->
    <div class="tab-content" id="tab-dashboard">
        <section class="dashboard">
            <h2>ğŸ“Š ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</h2>
            <div hx-get="/api/dashboard" hx-trigger="load, every 5s" hx-swap="innerHTML">
                Loading...
            </div>
        </section>
    </div>

    <!-- ã‚¿ãƒ–3: å±¥æ­´ -->
    <div class="tab-content" id="tab-history">
        <section class="command-history">
            <h2>ğŸ“œ ã‚³ãƒãƒ³ãƒ‰å±¥æ­´</h2>
            {% include "partials/history.html" %}
        </section>
    </div>
</div>

<script>
document.querySelectorAll('.tab-btn').forEach(btn => {
    btn.addEventListener('click', (e) => {
        e.preventDefault();
        e.stopPropagation();
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        btn.classList.add('active');
        document.getElementById('tab-' + btn.dataset.tab).classList.add('active');
        // å±¥æ­´ã‚¿ãƒ–: è‡ªå‹•æ›´æ–°ã—ãªã„ï¼ˆæ‰‹å‹•ã®ã€ŒğŸ”„ æ›´æ–°ã€ãƒœã‚¿ãƒ³ã§æ›´æ–°ï¼‰
    });
});

// Ctrl+Enter ã§é€ä¿¡
document.querySelector('textarea[name="instruction"]').addEventListener('keydown', (e) => {
    if (e.ctrlKey && e.key === 'Enter') {
        e.preventDefault();
        e.target.closest('form').requestSubmit();
    }
});

// Esc ã‚­ãƒ¼é€ä¿¡é–¢æ•°
function sendEscapeKey() {
    if (!confirm('Escã‚­ãƒ¼ã‚’å°†è»ã«é€ä¿¡ã—ã¾ã™ã‹ï¼Ÿ')) {
        return;
    }
    fetch('/api/special-key', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({key: 'Escape'})
    })
    .then(res => res.json())
    .then(data => {
        if (data.status === 'sent') {
            document.getElementById('command-result').innerHTML = '<p style="color:green;">Escã‚­ãƒ¼ã‚’é€ä¿¡ã—ã¾ã—ãŸ</p>';
        } else {
            document.getElementById('command-result').innerHTML = '<p style="color:red;">é€ä¿¡å¤±æ•—: ' + (data.message || 'Unknown error') + '</p>';
        }
    })
    .catch(err => {
        document.getElementById('command-result').innerHTML = '<p style="color:red;">é€ä¿¡ã‚¨ãƒ©ãƒ¼: ' + err + '</p>';
    });
}

// Esc ãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯
document.getElementById('esc-btn').addEventListener('click', sendEscapeKey);

// ãƒ–ãƒ©ã‚¦ã‚¶ã§Escã‚­ãƒ¼æŠ¼ä¸‹æ™‚
document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
        e.preventDefault();
        sendEscapeKey();
    }
});

// å±¥æ­´ã‚¿ãƒ–: ãƒˆã‚°ãƒ«ãƒœã‚¿ãƒ³ã®é–‹é–‰åˆ¶å¾¡ï¼ˆã‚¤ãƒ™ãƒ³ãƒˆå§”è­²ï¼‰
document.addEventListener('click', (e) => {
    if (e.target.classList.contains('toggle-btn')) {
        const content = e.target.nextElementSibling;
        if (content.style.display === 'none') {
            content.style.display = 'block';
            e.target.textContent = 'â–¼ éè¡¨ç¤º';
        } else {
            content.style.display = 'none';
            e.target.textContent = 'â–¶ è¡¨ç¤º';
        }
    }
    if (e.target.dataset && e.target.dataset.action === 'open-all') {
        document.querySelectorAll('.instruction-content').forEach(c => c.style.display = 'block');
        document.querySelectorAll('.toggle-btn').forEach(b => b.textContent = 'â–¼ éè¡¨ç¤º');
    }
    if (e.target.dataset && e.target.dataset.action === 'close-all') {
        document.querySelectorAll('.instruction-content').forEach(c => c.style.display = 'none');
        document.querySelectorAll('.toggle-btn').forEach(b => b.textContent = 'â–¶ è¡¨ç¤º');
    }
});

// WebSocket ã§ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ å‡ºåŠ›ã‚’å—ä¿¡ï¼ˆæŒ‡æ®ã‚¿ãƒ–ï¼‰
const ws = new WebSocket(`ws://${location.host}/ws`);
ws.onmessage = (e) => {
    const msg = JSON.parse(e.data);
    if (msg.output !== undefined) {
        const el = document.getElementById('shogun-output');
        const wasAtBottom = el.scrollHeight - el.scrollTop <= el.clientHeight + 50;
        el.innerHTML = '<pre>' + msg.output + '</pre>';
        // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒæœ€ä¸‹éƒ¨ä»˜è¿‘ã«ã„ã‚‹å ´åˆã®ã¿è‡ªå‹•ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
        if (wasAtBottom) {
            el.scrollTop = el.scrollHeight;
        }
    }
};
ws.onclose = () => {
    document.getElementById('shogun-output').innerHTML = '<pre>æ¥ç¶šãŒåˆ‡æ–­ã•ã‚Œã¾ã—ãŸã€‚ãƒšãƒ¼ã‚¸ã‚’ãƒªãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„ã€‚</pre>';
};

// ç›£è¦–ã‚¿ãƒ–: å…¨ãƒšã‚¤ãƒ³ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ è¡¨ç¤ºï¼ˆå·®åˆ†ãƒãƒ¼ã‚¸å¯¾å¿œï¼‰
const monitorPanes = {}; // ãƒšã‚¤ãƒ³å‡ºåŠ›ã®ãƒ­ãƒ¼ã‚«ãƒ«ã‚­ãƒ£ãƒƒã‚·ãƒ¥

const monitorWs = new WebSocket(`ws://${location.host}/ws/monitor`);
monitorWs.onmessage = (e) => {
    const msg = JSON.parse(e.data);
    if (msg.updates) {
        // å·®åˆ†ãƒãƒ¼ã‚¸: å¤‰æ›´ãŒã‚ã£ãŸpaneã®ã¿æ›´æ–°
        Object.entries(msg.updates).forEach(([paneId, output]) => {
            monitorPanes[paneId] = output;
        });
        renderMonitorPanes(monitorPanes);
    }
};
monitorWs.onclose = () => {
    const grid = document.getElementById('monitor-grid');
    if (grid) grid.innerHTML = '<div class="monitor-loading">æ¥ç¶šãŒåˆ‡æ–­ã•ã‚Œã¾ã—ãŸã€‚ãƒšãƒ¼ã‚¸ã‚’ãƒªãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„ã€‚</div>';
};

// ãƒšã‚¤ãƒ³æç”»é–¢æ•°
function renderMonitorPanes(panes) {
    const grid = document.getElementById('monitor-grid');
    if (!grid) return;

    // ãƒšã‚¤ãƒ³IDã§ã‚½ãƒ¼ãƒˆã—ã¦å®‰å®šã—ãŸè¡¨ç¤ºé †ã‚’ç¶­æŒ
    const sortedPaneIds = Object.keys(panes).sort((a, b) => {
        const numA = parseInt(a.replace(/\D/g, ''), 10) || 0;
        const numB = parseInt(b.replace(/\D/g, ''), 10) || 0;
        return numA - numB;
    });

    grid.innerHTML = sortedPaneIds.map(paneId => {
        const output = panes[paneId];
        return `
            <div class="pane-card" data-pane-id="${paneId}">
                <div class="pane-header">${paneId}</div>
                <div class="pane-output"><pre>${output}</pre></div>
            </div>
        `;
    }).join('');

    // å„ã‚«ãƒ¼ãƒ‰ã®è‡ªå‹•ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
    grid.querySelectorAll('.pane-output').forEach(el => {
        el.scrollTop = el.scrollHeight;
    });
}
</script>
{% endblock %}
